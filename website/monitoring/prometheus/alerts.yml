groups:
  - name: flowershop_alerts
    interval: 30s
    rules:
      # Алерт: Сервис недоступен
      - alert: ServiceDown
        expr: up{job="flowershop-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Сервис FlowerShop недоступен"
          description: "Сервис flowershop-backend недоступен более 1 минуты"

      # Алерт: Высокая ошибка HTTP (5xx)
      - alert: HighErrorRate
        expr: rate(http_server_requests_seconds_count{job="flowershop-backend",status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Высокий уровень ошибок HTTP 5xx"
          description: "Уровень ошибок HTTP 5xx превышает 0.1 запросов/сек"

      # Алерт: Медленный ответ (> 2 секунды)
      - alert: SlowResponse
        expr: histogram_quantile(0.99, rate(http_server_requests_seconds_bucket{job="flowershop-backend"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Медленный ответ сервиса"
          description: "99-й перцентиль времени ответа превышает 2 секунды"

      # Алерт: Высокая нагрузка на JVM
      - alert: HighJvmMemoryUsage
        expr: (jvm_memory_used_bytes{job="flowershop-backend",area="heap"} / jvm_memory_max_bytes{job="flowershop-backend",area="heap"}) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Высокое использование памяти JVM"
          description: "Использование heap памяти превышает 90%"

      # Алерт: Много активных подключений к БД
      - alert: HighDatabaseConnections
        expr: hikari_connections_active{job="flowershop-backend"} / hikari_connections_max{job="flowershop-backend"} > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Высокая нагрузка на подключения к БД"
          description: "Использование подключений к БД превышает 80%"

      # Алерт: Метрики не собираются
      - alert: NoMetricsScraped
        expr: up{job="flowershop-backend"} == 0
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "Метрики не собираются с сервиса"
          description: "Prometheus не может собрать метрики с flowershop-backend более 3 минут"
